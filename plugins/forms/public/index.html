<style>
	.CLASS .listing2 figure { background-color: #FFF; }
	.CLASS .listing2 figure { margin-bottom: var(--gap); }
	.CLASS .listing2 .date { font-size: 11px; color: #777; }
</style>

<div class="virtualwire hidden" data-if="CLASS">
	<ui-plugin>
		<ui-component name="searchinput" path="?.search" config="placeholder:@(Search navigation)" class="pull-right"></ui-component>
		<div class="pull-right">
			<button class="exec" data-exec="?/create"><i class="ti ti-plus-circle"></i>@(Create)</button>
			<button class="exec" data-exec="?/refresh"><i class="ti ti-refresh"></i>@(Refresh)</button>
		</div>
	</ui-plugin>
</div>

<ui-plugin config="aclass:1">

	<ui-component name="uidesigner" path="?.data" config="render:?/render;publish:?/publish;save:?/save;groups:?.groups;apps:?.apps;close:?/close;margin:0"></ui-component>

	<ui-component name="viewbox" config="parent:auto;margin:60" class="invisible">
		<div>
			<div class="padding">

				<ui-component name="empty" path="?.items" config="parent:auto;margin:60">

					<script type="text/html">
						<div>@(The library doesn't contain any items)</div>
						<div class="mt5">
							<span class="link exec" data-exec="?/create"><i class="ti ti-plus-circle green mr5"></i>@(Create first)</span>
						</div>
					</script>

					<div>
						<ui-component name="search" path="?.search" config="selector:figure;datasource:?.items">
							<ui-bind path="?.items" config="template" class="block">
								<script type="text/html">
									<div class="listing2 m grid-4 grid-md-2 grid-sm-2 grid-xs-1">
									{{ foreach m in value }}
										<figure class="exec" data-exec="?/open" data-id="{{ m.id }}" data-search="{{ m.name }}">
											<section>
												<div class="pull-right ml10">
													<span class="exec" data-exec="?/options" data-prevent="true"><i class="ti ti-cog"></i></span>
												</div>
												<div>
													<!--<div class="icon" style="{{ if m.color }}color:{{ m.color }}{{ fi }}"><i class="{{ m.icon }}"></i></div>-->
													<div class="name">{{ m.name }}</div>
													<div class="date">@(Updated:) {{ m.dtupdated | format('[date]') }}</div>
												</div>
											</section>
										</figure>
									{{ end }}
									</div>
								</script>
							</ui-bind>
						</ui-component>
					</div>

				</ui-component>
			</div>
		</div>
	</ui-component>


</ui-plugin>

<form id="uibuildrenderer" method="POST" target="_blank">
	<input name="data" type="hidden" />
</form>

<ui-component name="importer" path="common.form" config="if:formforms;url:/~ID~/form.html"></ui-component>

<script src="/~ID~/ui.js"></script>

<script>

	PLUGIN(function(exports) {

		var saving = false;

		RECONFIGURE('uidesigner', { upload: location.origin + ENV('upload') });

		exports.reload = function() {
			BREADCRUMB.add('@(Forms)', NAV.url);
			exports.refresh();
		};

		exports.refresh = function() {
			exports.tapi('forms @showloading ERROR', 'items @hideloading');
		};

		exports.create = function() {
			AJAX('GET /~ID~/ui.json @showloading', function(response) {
				response.id = 'form' + Date.now().toString(36);
				response.dtcreated = NOW;
				response.newbie = true;
				SET('formforms @reset @hideloading', response);
				SET('common.form', 'formforms');
			});
		};

		exports.edit = function(el) {
			var id = ATTRD(el);
			exports.tapi('forms_read/{0} @showloading ERROR'.format(id), function(response) {
				SET('formforms @reset @hideloading', response.editor);
				SET('common.form', 'formforms');
			});
		};

		exports.search = function() {
			SETTER('floatingsearch/show');
		};

		exports.open = function(el) {
			var id = ATTRD(el);
			exports.tapi('forms_read/{0} @showloading ERROR'.format(id), function(response) {
				exports.set('data @hideloading', response.editor);
			});
		};

		exports.close = function() {
			SET('common.unsaved', false);
		};

		exports.output = function(el) {
			var id = ATTRD(el);
			W.open('/render/{0}/'.format(id));
		};

		exports.save = function(data) {
			saving = true;
			exports.tapi('forms_save @showloading ERROR', { data: data }, function() {
				SETTER('notify/success', '@(UI design "{name}" has been saved)'.args(data, 'escape'));
				exports.refresh();
				saving = false;
			});
		};

		exports.publish = function(data) {
			// It's implemented on the server-side
		};

		exports.render = function(data) {
			var form = $('#uibuildrenderer');
			form.attr('action', '/render/');
			form.find('input').val(JSON.stringify(data));
			form.submit();
		};

		exports.options = function(el) {
			var id = ATTRD(el);
			var model = exports.model;
			var item = model.items.findItem('id', id);
			var opt = {};
			opt.align = 'right';
			opt.element = el;
			opt.items = [];

			opt.items.push({ id: 'open', name: '@(Open UI Builder)', classname: 'b', icon: 'ti ti-object-group' });
			opt.items.push({ id: 'edit', name: '@(Edit meta)', icon: 'ti ti-pencil' });

			if (item.published) {
				opt.items.push('-');
				opt.items.push({ id: 'preview', name: '@(Preview)', icon: 'ti ti-eye blue' });
				opt.items.push({ id: 'copy', name: '@(Copy link to the JSON)', icon: 'ti ti-copy' });
				opt.items.push({ id: 'copy2', name: '@(Copy link to the render)', icon: 'ti ti-copy' });
			}

			opt.items.push('-');
			opt.items.push({ id: 'remove', name: '@(Remove)', icon: 'ti ti-remove red' });
			opt.callback = function(selected) {

				switch (selected.id) {
					case 'download':
						location.href = '/download/{0}/{1}'.format(id, common.openplatform);
						break;
					case 'open':
						exports.open(id);
						break;
					case 'edit':
						exports.edit(id);
						break;
					case 'preview':
						exports.output(id);
						break;
					case 'copy':
					case 'copy2':
						SETTER('clipboard/copy', location.origin + (selected.id === 'copy' ? '/data/{0}.json' : '/render/{0}/').format(id));
						SETTER('sounds/play', 'badge');
						SETTER('notify/success', '@(Copied)');
						break;
					case 'remove':
						exports.remove(el);
						break;
				}

			};
			SETTER('menu/show', opt);
		};

		exports.remove = function(el) {
			var id = ATTRD(el);
			SETTER('approve/show', '@(Are you sure you want to remove selected designs?)', '"ti ti-trash" @(Remove)', function() {
				SETTER('sounds/play', 'badge');
				exports.tapi('forms_remove/{0} @showloading ERROR'.format(id), exports.refresh);
			});
		};

		exports.permissions = function(value, path, el) {
			el.find('.D').prop('disabled', UNAUTHORIZED('library_create'));
		};

		exports.importer = function() {
			var opt = {};
			opt.accept = 'application/json';
			opt.multiple = true;
			opt.callback = function(file) {
				var data = PARSE(file.body);
				if (data) {
					SETTER('sounds/play', 'badge');
					SETTER('notify/success', '@(UI design "{name}" has been saved)'.args(data, 'escape'));
					exports.tapi('forms_save @showloading ERROR', { data: data }, exports.refresh);
				}
			};
			SETTER('filereader/open', opt);
		};

		exports.export = function() {
			location.href = '/download/' + common.openplatform;
		};

	});

</script>